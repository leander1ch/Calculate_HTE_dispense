# HTE Dispense Calculator

<p align="center">
  <img src="logo_Scat.png" alt="SwissCat+ EPFL" width="150"/>
</p>

This repository contains a Python script for calculating reagent and solvent amounts for high-throughput experimentation (HTE) reactions. The script guides the user through entering reagents, specifying dispensing locations on a plate, and calculating masses or volumes required in each well.

In addition to the calculator, the repository includes utilities to check workflows,
analyse reaction outcomes, and a high-level orchestrator that runs the entire
process end-to-end.

## Requirements
- Python 3.8+
- pandas
- numpy
- requests
- openpyxl
- matplotlib
- scipy

Install dependencies with:

```bash
pip install -r requirements.txt
```

## Quick Start – full automated workflow

`HTE_Workflow.py` ties together calculation, workflow validation and
post‑reaction analysis.  It applies the naming scheme
`date_experimentname_experimentnumber_content` to every generated file.

```bash
python HTE_Workflow.py
```

The script will:

1. run `hte_calculator.py` to gather reagents (from a preload file or by
   interactive input) and produce an `actual_*.xlsx` layout
2. call `workflow_checker.py --fill --visualize` to insert the calculated
   volumes into the workflow and create layout images
3. execute `reaction_analyser.py`, which in turn runs `analysis.py` and
   `dispense_analyser.py`, normalizes yields against the limiting reagent
   and saves heatmaps and pie plots
4. return the parsed yield data for further processing

## Manual script usage

The tools can also be invoked individually as detailed below.

### Calculator

```bash
python hte_calculator.py [--preload my_reagents.py]
```

The script interactively prompts for reagents and plate layout.  Results are saved
as an Excel file summarizing the amounts for each well.  Supplying `--preload`
loads `PRELOADED_REAGENTS` from the given file before prompting.

During execution you will be asked for a reaction name (used for the Excel/figure
filenames) and the plate format (24, 48 or 96 wells).  Warnings are shown if any
well lacks solvent or the limiting reagent.  A colour‑coded layout image is also
created for quick visual inspection of reagent distribution.

### Example

```bash
python hte_calculator.py --preload example_reagents.py
```

This writes `actual_<name>.xlsx` which lists the amounts per well.

### Workflow Checker

`workflow_checker.py` compares a workflow Excel file with the output
generated by `hte_calculator.py` and can write the calculated amounts
directly back into the workflow.  Run it with the calculator export and
the **empty** workflow file.  Use `--fill` to modify the workflow in
place before the first orbital shaker step:

```bash
python workflow_checker.py actual.xlsx workflow_empty.xlsx --fill
```

Add `--visualize` to generate plate layout images using `layout_parser.py`:

```bash
python workflow_checker.py actual.xlsx workflow_empty.xlsx --fill --visualize
```

This will call `layout_parser.py` internally to create PNG files showing
the reagent distribution and workflow steps.

### Complete workflow

1. Run `hte_calculator.py` to produce `actual.xlsx`.
2. Fill in the virtual twin in ArcSuite and make sure the product names match the ones
   in `actual.xlsx`.
3. Download the empty workflow file and fill in the product names and reaction conditions.
4. Run `workflow_checker.py actual.xlsx empty.xlsx --fill` to populate the
   workflow file with dispense volumes.
5. (Optional) Re-run with `--visualize` to create layout images for review.

### Reaction analysis

`reaction_analyser.py` combines chromatogram analysis with dispense accuracy
normalization.

```bash
python reaction_analyser.py
```

It will prompt for analysis CSV files and the `actual.xlsx` layout if needed,
then run `analysis.py` and `dispense_analyser.py`, normalizing yields against the
chosen limiting reagent.  Heatmaps and pie charts are written to PNG files and the
normalized data are appended to the analysis workbook.

#### analysis.py

```bash
python analysis.py folder_with_csvs --calibration --visualize --output analysis_output.xlsx
```

`analysis.py` processes raw analysis CSV files.  `--calibration` runs
`calibration.py` first, `--visualize` generates plots and `--layout` can supply
an `actual.xlsx` file for ordering experiments.

#### calibration.py

```bash
python calibration.py folder_with_calibration_csvs
```

Builds calibration curves from dedicated CSV files.

#### dispense_analyser.py

```bash
python dispense_analyser.py RunStatistics.xlsx actual.xlsx --output dispense_analysis.xlsx
```

Creates dispense accuracy statistics and relative differences per well.

### Visualize existing workflow

Use `layout_parser.py` to render layout images from any workflow:

```bash
python layout_parser.py workflow.xlsx
```

